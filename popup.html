<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Checklist Filter</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 12px;
      margin: 0;
    }

    h3 {
      margin-top: 0;
    }

    select, button {
      width: 100%;
      padding: 8px;
      margin-top: 8px;
      box-sizing: border-box;
    }

    label {
      display: flex;
      align-items: center;
      margin-top: 10px;
      gap: 6px;
    }

    ul {
      margin-top: 12px;
      padding-left: 18px;
      max-height: 320px;
      overflow-y: auto;
    }

    li {
      margin-bottom: 6px;
    }

    a {
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <h3>Filter Checklist Items</h3>

  <select id="memberSelect">
    <option value="">Loading members...</option>
  </select>

  <label>
    <input type="checkbox" id="openOnly" checked />
    Show open items only
  </label>

  <button id="runFilter">Show Items</button>

  <ul id="results"></ul>

  <script>
    const t = window.TrelloPowerUp.iframe();

    async function loadMembers() {
      try {
        const board = await t.board('members');
        const select = document.getElementById('memberSelect');

        select.innerHTML = '';

        board.members.forEach(member => {
          const option = document.createElement('option');
          option.value = member.id;
          option.textContent = member.fullName;
          select.appendChild(option);
        });

      } catch (err) {
        console.error('Error loading members:', err);
      }
    }

    async function filterChecklistItems() {
      const memberId = document.getElementById('memberSelect').value;
      const openOnly = document.getElementById('openOnly').checked;
      const resultsEl = document.getElementById('results');

      if (!memberId) {
        resultsEl.innerHTML = '<li>Select a member first.</li>';
        return;
      }

      resultsEl.innerHTML = '<li>Searching...</li>';

      try {
        const cards = await t.cards('id', 'name', 'url', 'checklists');
        const matches = [];

        cards.forEach(card => {
          (card.checklists || []).forEach(checklist => {
            checklist.checkItems.forEach(item => {
              const assignedMatch = item.idMember === memberId;
              const statusMatch =
                !openOnly || item.state === 'incomplete';

              if (assignedMatch && statusMatch) {
                matches.push({
                  cardName: card.name,
                  cardUrl: card.url,
                  itemName: item.name
                });
              }
            });
          });
        });

        resultsEl.innerHTML = '';

        if (matches.length === 0) {
          resultsEl.innerHTML = '<li>No items found.</li>';
          return;
        }

        matches.forEach(match => {
          const li = document.createElement('li');

          const link = document.createElement('a');
          link.href = match.cardUrl;
          link.target = '_blank';
          link.textContent =
            `${match.itemName} (Card: ${match.cardName})`;

          li.appendChild(link);
          resultsEl.appendChild(li);
        });

      } catch (err) {
        console.error('Error filtering items:', err);
        resultsEl.innerHTML =
          '<li>Error loading checklist items.</li>';
      }
    }

    document
      .getElementById('runFilter')
      .addEventListener('click', filterChecklistItems);

    loadMembers();
  </script>
</body>
</html>
