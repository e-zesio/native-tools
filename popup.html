<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Checklist Filter</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 12px;
      margin: 0;
    }

    h3 {
      margin-top: 0;
    }

    select, button {
      width: 100%;
      padding: 8px;
      margin-top: 8px;
      box-sizing: border-box;
    }

    label {
      display: flex;
      align-items: center;
      margin-top: 10px;
      gap: 6px;
    }

    ul {
      margin-top: 12px;
      padding-left: 18px;
      max-height: 320px;
      overflow-y: auto;
    }

    li {
      margin-bottom: 6px;
    }

    a {
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <h3>Filter Checklist Items</h3>

  <select id="memberSelect">
    <option value="">Loading members...</option>
  </select>

  <label>
    <input type="checkbox" id="openOnly" checked />
    Show open items only
  </label>

  <button id="runFilter">Show Items</button>

  <ul id="results"></ul>

  <script>
    const t = window.TrelloPowerUp.iframe();

    async function loadMembers() {
      try {
        const board = await t.board('members');
        const select = document.getElementById('memberSelect');

        select.innerHTML = '';

        board.members.forEach(member => {
          const option = document.createElement('option');
          option.value = member.id;
          option.textContent = member.fullName;
          select.appendChild(option);
        });

      } catch (err) {
        console.error('Error loading members:', err);
      }
    }

   async function filterChecklistItems() {
  const memberId = document.getElementById('memberSelect').value;
  const openOnly = document.getElementById('openOnly').checked;
  const resultsEl = document.getElementById('results');

  const log = (msg, obj = null) => {
    console.log('[ChecklistFilter]', msg, obj || '');
    const li = document.createElement('li');
    li.textContent = obj
      ? `${msg}: ${JSON.stringify(obj).slice(0, 200)}`
      : msg;
    resultsEl.appendChild(li);
  };

  resultsEl.innerHTML = '';

  if (!memberId) {
    log('No member selected');
    return;
  }

  try {
    log('Fetching cards…');

    const cards = await t.cards('id', 'name', 'checklists');

    log(`Loaded ${cards.length} cards`);

    const matchingCards = [];

    for (const card of cards) {
      if (!card.checklists || !Array.isArray(card.checklists)) {
        log(`Card "${card.name}" has no checklists`);
        continue;
      }

      let cardMatches = false;

      for (const checklist of card.checklists) {
        if (!checklist.id) {
          log('Checklist missing id', checklist);
          continue;
        }

        log(`Fetching checklist ${checklist.id}`);

        // IMPORTANT: fetch full checklist explicitly
        const fullChecklist = await t.get(
          `/checklists/${checklist.id}`
        );

        if (
          !fullChecklist ||
          !Array.isArray(fullChecklist.checkItems)
        ) {
          log('Checklist missing items', fullChecklist);
          continue;
        }

        for (const item of fullChecklist.checkItems) {
          const assignedMatch =
            item.idMember === memberId;

          const statusMatch =
            !openOnly || item.state === 'incomplete';

          if (assignedMatch && statusMatch) {
            log(
              `Match found in "${card.name}" → ${item.name}`
            );
            cardMatches = true;
          }
        }
      }

      if (cardMatches) {
        matchingCards.push(card.name);
      }
    }

    log(
      `Done. Matching cards: ${matchingCards.length}`,
      matchingCards
    );
  } catch (err) {
    console.error('FILTER ERROR:', err);
    log(`ERROR: ${err.message}`);
  }
}



    document
      .getElementById('runFilter')
      .addEventListener('click', filterChecklistItems);

    loadMembers();
  </script>
</body>
</html>
